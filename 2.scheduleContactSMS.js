fn(state => {
  // prettier-ignore
  const mapping={"09B - Bracing Night Campaign Y1":[{"# Alert":"9B","# SMS":12,"Condition":"send_sms = 'on' AND sms_opt_in_educational = 'yes' AND treatment = \"bracing_night","Recipients":"","Schedule Start Date (SSD)":"now","Days from SSD":196,"":16,"Clock Time":"10:00","Min From SSD":"","Country Recipients":"","Educational":"Educational","Reminder":"","message unique id/bulkId":"bracing_night_campaign-12-{form.case.case_id}","PHI":["Hi ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". Kung si ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," naay mga hayag nga mga pula-pula o mga nalut-han, lu-ag ra ang iyang mga sapatos. Siguraduha nga ang iyang takong kay sangko sa laplapa sa sapatos."],"EN":["Hi ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". If ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," has bright red spots or blisters. ","pronoun_his_her"," shoe may not be on tightly enough. Make sure that ","pronoun_his_her"," heel is down in the shoe."],"FRA":["Bonjour, ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". Si ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," a des taches rouges vives ou des ampoules, c'est qu' ","pronoun_his_her"," n'a pas sa chaussure assez serrée. Assurez-vous que le talon est bien dans la chaussure."],"ES":["Hola, ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". Si ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," tiene manchas rojas o ampollas brillantes puede que la ferula no esté lo suficientemente apretado. Asegúrate de que su talón esté dentro del zapato."],"MLG":["Salama ! ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name"," raha toa ka misy teboteboka na tasitasy menamena amin'ny tongotr'i ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," dia mety tsy ao tsara amin'ny tongony ny kirarony. Ataovy izay ahazoana antoka fa mitsatoka tsara amin'ny kiraro ny voditongony"],"MYA":["မင်္ဂလာပါ ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name","။ တကယ်လို့ ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," မှာ အနီစက်တွေ ဒါမှမဟုတ် အရည်ကြည်ဖုတွေ ရှိနေရင် ","pronoun_his_her"," ရဲ့ဖိနပ်ကို ကျပ်အောင်မစီးလို့ ဖြစ်နိုင်ပါတယ်။ ","pronoun_his_her"," ရဲ့ဖနောင့်ကို ဖိနပ်ထဲဝင်နေအောင်ထားပါ။"],"KHM":["សួស្តី ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name","។ បើ ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," មានស្នាមក្រហម និងពងទឹកលើស្បែក ","pronoun_his_her"," ស្បែកជើងរណបអាចមិនត្រូវបានពាក់តឹងល្មមនោះឡើយ។ ត្រូវប្រាកដថាកែងជើងរបស់ ","pronoun_his_her"," ធ្លាក់ចុះទៅដល់បាតស្បែកជើងពេលពាក់ស្បែកជើងរណប។"],"NEP":["नमस्ते ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name"," ज्यू । यदी ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," को शरीरमा उज्याला रातो टाटा वा फोकाहरु देखिएमा उहाँको जुत्ता मिल्नेगरी कस्सिएको नहुन सक्छ । उहाँको कुर्कुच्चा जुत्तामा परेको छ भनी पक्का गर्नुहोस् ।"],"SW":["Hujambo ","guradian1_first_name",". Iwapo ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," ana madoa mekundu ama uvimbe, kiatu chake kinaweza kuwa hakijabanwa kwa kutosha. Hakikisha kwamba kisigino chake kiko chini ndani ya kiatu."],"TGL":["Kumusta, ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". Kung namumula o may paltos si ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name",", maaaring hindi sapat ang higpit ng sapatos niya. Tiyaking nakalapat ang kanyang sakong sa sapatos."],"WOL":["Salaam maalikum, ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". Su ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," amee ay gàkk-gàkk  yu xonx  walla ay gamb , dafay wone ni, ","pronoun_his_her"," solul dàll wi ba mu daŋ.Na leen wóor ni téstén wi egg na ci suuf dàll wi.."]},{"# Alert":"9B","# SMS":13,"Condition":"send_sms = 'on' AND sms_opt_in_educational = 'yes' AND treatment = \"bracing_night","Recipients":"","Schedule Start Date (SSD)":"now","Days from SSD":224,"":44,"Clock Time":"10:00","Min From SSD":"","Country Recipients":"","Educational":"Educational","Reminder":"","message unique id/bulkId":"bracing_night_campaign-13-{form.case.case_id}","PHI":["Hi ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". Importante gayud kaayo nga ang takong ni ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," kay magpabilin sa sulod sa sapatos kung nagsuot siya sa brace aron mutalab ang pagpa-ayo!"],"EN":["Hi ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". It is very important that ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name","'s heel stays completely inside the shoe when ","form.calcs.sms.pronoun_he_she"," wears the brace in order for the treatment to work!"],"FRA":["Bonjour, ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". Il est très important que le talon de ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," reste complètement à l'intérieur de la chaussure lorsque ","pronoun_he_he_she"," porte l'attelle pour que le traitement fonctionne!"],"ES":["Hola, ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". ¡Es muy importante que el talón de ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," permanezca completamente dentro del zapato cuando use la ferula para que el tratamiento funcione!"],"MLG":["Salama ! ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name"," Tena zava-dehibe ny hoe tena mitsatoka tsara ao anaty kiraro ny voditongotr'i ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," rehefa manao kiraro manokana fanitsiana tongotra izy mba hampahomby ny fitsaboana."],"MYA":["မင်္ဂလာပါ ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name","။ ကုသမှု ထိရောက်အောင် ","form.calcs.sms.pronoun_he_she"," က ဖိနပ် (brace)ဝတ်တဲ့အခါမှာ ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," ရဲ့ ဖနောင့်က ဖိနပ်ထဲကိုလုံးဝ ရောက်နေဖို့ အရမ်းအရေးကြီးပါတယ်။"],"KHM":["សួស្តី ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name","។ ជាការសំខាន់ណាស់ដែលកែងជើងរបស់ ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," ត្រូវនៅក្នុងស្បែកជើង'នៅពេលដែល ","form.calcs.sms.pronoun_he_she"," ពាក់ស្បែកជើងរណប ដើម្បីឲ្យការព្យាបាលមានប្រសឹទ្ធិភាព !"],"NEP":["नमस्ते ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name"," ज्यू । उपचारले काम गर्नका लागी ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," का कुर्कुच्चा जुत्ता भित्र पूरै हुनु धेरै जरुरी छ ।"],"SW":["Hujambo ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". Ni muhumu sana kwamba kisigino cha ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," kinakaa ndani ya kiatu kabisa wakati anapovaa brace ili matibabu yafaulu!"],"TGL":["Kumusta, ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". Mahalagang nakalapat ang sakong ni ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," sa sapatos sa tuwing suot niya ang brace upang masiguro ang tulugang paggaling ng kaniyang mga paa!"],"WOL":["Salaam maalikum, ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". Dina am solo lool bu tésténu  ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," nekkee ci biir dàll wi su  ","pronoun_he_he_she"," solee àppaare bi ngir paj mi jaar yoon!"]},{"# Alert":"9B","# SMS":14,"Condition":"send_sms = 'on' AND sms_opt_in_educational = 'yes' AND treatment = \"bracing_night","Recipients":"","Schedule Start Date (SSD)":"now","Days from SSD":252,"":72,"Clock Time":"10:00","Min From SSD":"","Country Recipients":"","Educational":"Educational","Reminder":"","message unique id/bulkId":"bracing_night_campaign-14-{form.case.case_id}","PHI":["Hi ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". Kung si ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," kay mmalut-han o mga nuka-nuka gikan sa brace, ayaw ug gamit ug losyon o mga lana sa pagtabang sa pag-ayo sa panit. Makasamot ni siya sa problema."],"EN":["Hi ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". If ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," gets blisters or rashes from ","pronoun_his_her"," brace, do not use lotion or oil to help heal the skin. It will make the problem worse."],"FRA":["Bonjour, ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". Si ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," souffre d'ampoules ou d'éruptions cutanées, n'utilisez pas de lotion ou d'huile pour aider à guérir la peau. Cela ne fera qu'aggraver le problème."],"ES":["Hola, ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". Si ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," tiene ampollas o sarpullidos causados por la ferula, no uses lociones ni aceites para ayudar a curar la piel. Solo harán que el problema empeore."],"MLG":["Salama ! ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". Aza asiana tsirano-panafody na menaka ny hoditra na faritra mangidihidy eo amin'i ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," rehefa manao ilay kiraro izy fa mety hampitombo ny olana izany."],"MYA":["မင်္ဂလာပါ ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name","။ တကယ်လို့ ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," က ","pronoun_his_her"," ဖိနပ် (brace)ကြောင့် အရည်ကြည်ဖုတွေ၊ အနီကွက်တွေ ဖြစ်လာရင် အရေပြားသက်သာအောင် လိမ်းဆေးတွေ၊ အဆီတွေ မလိမ်းပါနဲ့။ ပိုဆိုးသွားပါလိမ့်မယ်။"],"KHM":["សួស្តី ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name","។ បើ ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," មានពងបែក ឬរមាស់បណ្តាលមកពីស្បែកជើងរណប ","pronoun_his_her",", សូមកុំប្រើឡេ ឬប្រេងជំនួយស្បែក។ វានឹងបណ្តាលឲ្យបញ្ហាកាន់តែធំឡើង។"],"NEP":["नमस्ते ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name"," ज्यू । यदी ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," को सहायेक् उपकरन (डि.बी शूज) को कारण छालामा फोकाहरु वा डाबरहरु आएमा त्यसलाई निको पार्न लोशन वा तेलको प्रयोग नगर्नुहोला । यसले समस्यालाई झन जटिल बनाउँछ ।"],"SW":["Hujambo ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". Iwapo ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," amepata uvimbe ama kukerwa na ngozi kutokana na kuvaa brace, usitumie lotion au mafuta kusaidia kutibu ngozi. Itaifanya iwe mbaya zaidi."],"TGL":["Kumusta, ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". Kung nagkapaltos o nagkapantal si ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," sa pagsusuot niya ng brace, huwag itong pahiran ng lotion o langis. Lalo lamang nitong palalalain ang problema."],"WOL":["Salaam maalikum, ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". Su ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," amee gamb yuy metti walla ay picc yu génn ci yaram wi,buleen jëfandikoo lu xeetoo lajkoloñ mbaa diwlin ngir jéem koo faj.Loolu dafay yokk jafe-jafe yi rekk."]},{"# Alert":"9B","# SMS":15,"Condition":"send_sms = 'on' AND sms_opt_in_educational = 'yes' AND treatment = \"bracing_night","Recipients":"","Schedule Start Date (SSD)":"now","Days from SSD":253,"":73,"Clock Time":"10:00","Min From SSD":"","Country Recipients":"","Educational":"Educational","Reminder":"","message unique id/bulkId":"bracing_night_campaign-15-{form.case.case_id}","PHI":["Siguraduha nga ang mga tiil ni ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," kay uga kung ibutang nimu ang brace, ug pakig-istorya sa imong doktor kung naa kay gikabalak-an."],"EN":["Make sure ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name","'s feet are dry when you put the brace on, and talk to the doctor if you are concerned."],"FRA":["Assurez-vous que les pieds de ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," soient secs lorsque vous mettez l'attelle, et parlez-en au médecin si vous êtes inquiet."],"ES":["Asegúrate de que los pies de ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," estén secos cuando se ponga la ferula, y habla con el médico en caso de preocupación."],"MLG":["Ataovy izay ahazoana antoka fa maina tsara ny tongotr'i ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," rehefa mametraka ny kiraro manokana amin'izany ianao, ary ambarao amin'ny dokotera raha misy fanahiana aminao ny amin'izany"],"MYA":["ဖိနပ် (brace)ဝတ်ပေးချိန်မှာ ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," ရဲ့ခြေထောက်တွေ ခြောက်နေရပါမယ်။ စိုးရိမ်တယ် ဆိုရင်တော့ ဆရာဝန်ကို ပြောပြပါ။"],"KHM":["ត្រូវប្រាកដថាប្រអប់ជើងរបស់ ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," ស្ងួតនៅពេលបំពាក់ស្បែកជើងរណប និងពិភាក្សាជាមួយវេជ្ជបណ្ឌិតបើអ្នកមានកង្វល់។"],"NEP":["सहायेक् उपकरन (डि.बी शूज)  बाँधिदिनु भन्दा पहिले ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," को खुट्टाहरु सुक्खा छन् भनी पक्का गर्नुहोस् र यदी तपाई चिन्तित हुनुहुन्छ भने डाक्टरसंग सल्लाह गर्नुहोस् ।"],"SW":["Hakikisha miguu ya ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," imekauka kabla ya kuweka brace. Ongea na daktari iwapo una wasiwasi."],"TGL":["Tiyaking tuyo ang mga paa ni ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," sa tuwing isinusuot niya ang brace, at makipag-usap sa inyong doktor kung kayo'y may mga katanungan o pag-aalala."],"WOL":["Na leen wóor ni  tànki  ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," wow nañu laata ngeen di ko solal àppaare bi te itam, waxtaanleen ci ak doktoor bi su ngeen ci amee ag jaaxle."]},{"# Alert":"9B","# SMS":16,"Condition":"send_sms = 'on' AND sms_opt_in_educational = 'yes' AND treatment = \"bracing_night","Recipients":"","Schedule Start Date (SSD)":"now","Days from SSD":280,"":100,"Clock Time":"10:00","Min From SSD":"","Country Recipients":"","Educational":"Educational","Reminder":"","message unique id/bulkId":"bracing_night_campaign-16-{form.case.case_id}","PHI":["Hi ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". Ayaw ug undang ug paggamit sa brace kada gabie hangtud mu-ingon ang doktor nga pwede na."],"EN":["Hi ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". Don't stop using the brace at night until the doctor says it is okay."],"FRA":["Bonjour, ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". N'arrêtez pas d'utiliser l'attelle la nuit jusqu'à ce que le médecin vous dise que c'est bon."],"ES":["Hola, ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". No dejes de usar la ferula durante la noche hasta que el médico lo autorice."],"MLG":["Salama ! ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name"," Aza ajanona mihitsy ny fampiasana ny  kiraro manokana amin'ny alina mandra-pilazan'ny dokotera ny fahasitranana tanteraka."],"MYA":["မင်္ဂလာပါ ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name","။ ဆရာဝန်က အဆင်ပြေပြီလို့ ပြောတဲ့အချိန်အထိ ဖိနပ် (brace)ကို ညဘက်မှာ ဝတ်ထားရပါမယ်။"],"KHM":["សួស្តី ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name","។ សូមកុំបញ្ឈប់ការពាក់ស្បែកជើងរណបនៅពេលយប់ រហូតទាល់តែវេជ្ជបណ្ឌិតប្រាប់ឲ្យឈប់។"],"NEP":["नमस्ते ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name"," ज्यू । डाक्टरले हुन्छ नभनेसम्म बेलुका सहायेक् उपकरन (डि.बी शूज)  लगाउन नछाड्नुहोस् ।"],"SW":["Hujambo ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". Usiache kutumia brace usiku mpaka daktari asema ni sawa."],"TGL":["Kumusta, ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". Huwag ihinto ang pagsuot ng brace sa gabi hanggang sabihin ng inyong doktor na maaari na itong hindi isuot."],"WOL":["Salaam maalikum, ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". Buleen bàyyee jëfandikoo àppaare bi fii ak doktoor bi waxu leen baax na."]},{"# Alert":"9B","# SMS":17,"Condition":"send_sms = 'on' AND sms_opt_in_educational = 'yes' AND treatment = \"bracing_night","Recipients":"","Schedule Start Date (SSD)":"now","Days from SSD":308,"":128,"Clock Time":"10:00","Min From SSD":"","Country Recipients":"","Educational":"Educational","Reminder":"","message unique id/bulkId":"bracing_night_campaign-17-{form.case.case_id}","PHI":["Hi ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". Pwede ra nimu permi ipahibalo ang mga problema sa imong doktor bahin sa pagpa-ayo ni ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name","."],"EN":["Hi ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". You can always let your doctor know about problems with ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name","'s treatment."],"FRA":["Bonjour, ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". Vous pouvez toujours informer votre médecin des problèmes liés au traitement de ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name","."],"ES":["Hola, ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". Siempre puedes hacerle saber a tu médico cualquier problema relacionado con el tratamiento de ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name","."],"MLG":["Salama ! ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name"," Azonao atao hatrany ny mampahafantatra ny dokoteranao mikasika ny olana mifandraika amin'ny fitsaboana an'i ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name",""],"MYA":["မင်္ဂလာပါ ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name","။ ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," ရဲ့ ကုသမှုနဲ့ ပတ်သက်တဲ့ ပြဿနာတွေကို သင့်ရဲ့ဆရာဝန်ကို အချိန်မရွေး ပြောပြနိုင်ပါတယ်။"],"KHM":["សួស្តី ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name","។ អ្នកអាចប្រាប់វេជ្ជបណ្ឌិតរបស់អ្នកឲ្យបានដឹងពីបញ្ហានៅក្នុងការព្យាបាលរបស់ ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name","។"],"NEP":["नमस्ते ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name"," ज्यू । ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," को उपचारका क्रममा कुनै समस्या भए तपाईको डाक्टरलाई थाहा दिन सक्नु हुन्छ ।"],"SW":["Hujambo ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". Unaweza kuambia daktari wako kuhusu shida zinazotokana na matibabu ya ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," wakati wowote."],"TGL":["Kumusta, ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". Anumang oras ay maaari ninyong ipaalam sa inyong doktor ang mga problema kaugnay sa gamutan ni ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name","."],"WOL":["Salaam maalikum, ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". Saa yu nekk mën ngeen a jokkoo ak seen doktoor ci jafe-jafe yi jëm ci pajum  ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name","."]},{"# Alert":"9B","# SMS":18,"Condition":"send_sms = 'on' AND sms_opt_in_educational = 'yes' AND treatment = \"bracing_night","Recipients":"","Schedule Start Date (SSD)":"now","Days from SSD":336,"":156,"Clock Time":"10:00","Min From SSD":"","Country Recipients":"","Educational":"Educational","Reminder":"","message unique id/bulkId":"bracing_night_campaign-18-{form.case.case_id}","PHI":["Hi ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". Padayuna ang imong maayong ginabuhat. Hinumdumi nga importante para kang ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," nga isuot niya ang brace kada gabie para makadagan-dagan ug makadula siya ma-adlawan."],"EN":["Hi ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". Keep up the good work. Remember it is important for ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," to wear the brace during the night, so that ","form.calcs.sms.pronoun_he_she"," will be able to run and play."],"FRA":["Bonjour, ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". Continuez votre bon travail. Rappelez-vous qu'il est important que ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," porte l'attelle pendant la nuit, afin que ","form.calcs.sms.pronoun_he_she"," puisse courir et jouer à l'avenir."],"ES":["Hola, ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". Sigue con el buen trabajo. Recuerda que es importante que ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," use la barra durante la noche, para que ","form.calcs.sms.pronoun_he_she"," pueda correr y jugar."],"MLG":["Salama ! ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name"," Tohizo fa tsara! Aza hadinoina fa zava-dehibe ho an'i ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," ny mitondra hatrany ny kiraro manokana fanitsiana tongotra mandritra ny alina ka amin'izay izy dia ho afaka mihazakazaka sy milalao indray izy."],"MYA":["မင်္ဂလာပါ ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name","။ ကောင်းမွန်တဲ့ ဆောင်ရွက်ချက်ကို ထိန်းထားပါ။ ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," က ညဘက်မှာ ဖိနပ် (brace) ဝတ်ထားမှသာ ","form.calcs.sms.pronoun_he_she"," ပြေးလွှားဆော့ကစားနိုင်မယ်ဆိုတာ မမေ့ပါနဲ့။"],"KHM":["សួស្តី ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name","។ សូមព្យាយាមធ្វើឲ្យបានល្អ។ សូមចាំថា ប្រសើរបំផុតត្រូវឲ្យ ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," ពាក់ស្បែកជើងរណបនៅពេលយប់ ដើម្បីឲ្យ ","form.calcs.sms.pronoun_he_she"," អាចរត់ និងលេងបាន។"],"NEP":["नमस्ते ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name"," ज्यू । राम्रो कार्य जारी राख्नुहोस् । याद राख्नुहोस्, ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," ले राती सहायेक् उपकरन (डि.बी शूज)  लगाई     राख्न जरुरी हुन्छ, ताकी उहाँ खेल्न र कुद्न सक्षम हुनुहुनेछ ।"],"SW":["Hujambo ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". Endelea na kazi nzuri unayofanya. Daima kumbuka kuwa ni muhimu kwa ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," kuvaa brace wakati wa usiku, ili apate uwezo kukimbia na kucheza."],"TGL":["Kumusta, ","form.calcs.save.guardian1_first_name || form.case.update.guardian1_first_name",". Ipagpatuloy ang magandang gawa. Tandaan, mahalagang suot ni ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," ang brace sa gabi, upang sa kalaunan siya ay makatakbo at makapaglaro."],"WOL":["Salaam maalikum, ","case guardian1_first_name",". Wéyleen ci seen liggéey bu baax bii.Fàttalikuleen ni am na solo lool su  ","form.calcs.case_properties.patient_first_name || form.case.update.patient_first_name"," dee sol àppaare bi ci guddi gi ngir ","form.calcs.sms.pronoun_he_she"," mën a daw ak di fo bu ëllëgee."]}]}

  const treatmentMap = {
    bracing_night_y1: {
      key: '09B - Bracing Night Campaign Y1',
      bulkPrefix: 'bracing_night_campaign-',
    },
  };

  const timeZoneMap = {
    'Africa/Kinshasa': '+01:00',
    'America/Managua': '-06:00',
    'America/Asuncion': '-04:00',
    'America/Guatemala': '-06:00',
    'America/Guayaquil': '-05:00',
    'America/Sao_Paulo': '-03:00',
    'America/La_Paz': '-04:00',
    'Asia/Yangon': '+06:30',
    'Asia/Colombo': '+05:30',
    'Asia/Manila': '+08:00',
    'Asia/Kathmandu': '+05:45',
    'Asia/Phnom_Penh': '+07:00',
    'Asia/Kolkata': '+05:30',
    'Asia/Dhaka': '+06:00',
    'Asia/Jakarta': '+07:00',
    'Africa/Freetown': '+00:00',
    'Africa/Dakar': '+00:00',
    'Africa/Kinshasa': '+01:00',
    'Africa/Lagos': '+01:00',
    'Africa/Casablanca': '+00:00',
    'Africa/Bamako': '+00:00',
    'Africa/Monrovia': '+00:00',
    'Africa/Conakry': '+00:00',
    'Africa/Banjul': '+00:00',
    'Africa/Harare': '+02:00',
    'Africa/Nairobi': '+03:00',
    'America/Panama': '-05:00',
    'US/Central': '-06:00',
  };

  const PhoneMapping = {
    220: 'GCF',
    'The Gambia': 'GCF',
    224: 'PONSETIGN',
    Guinea: 'PONSETIGN',
    231: 'LIBclubfoot',
    Liberia: 'LIBclubfoot',
    261: 'GASYPIEDBOT',
    Madagascar: 'GASYPIEDBOT',
    223: 'PiedBotMali',
    Mali: 'PiedBotMali',
    212: 'MarocPBVE',
    Morocco: 'MarocPBVE',
    234: 'TSCFFOOT',
    Nigeria: 'TSCFFOOT',
    242: 'PiedbotCG',
    'Republic of the Congo': 'PiedbotCG',
    221: 'laagotankSN',
    Senegal: 'laagotankSN',
    232: 'SALONKLUFUT',
    'Sierra Leone': 'SALONKLUFUT',
    252: 'BISHACAS',
    Somalia: 'BISHACAS',
    211: 'CLUBFOOT',
    'South Sudan': 'CLUBFOOT',
    255: 'MGUUKIFUNDO',
    Tanzania: 'MGUUKIFUNDO',
    256: 'CLUBFOOT',
    Uganda: 'CLUBFOOT',
    505: 'EQUINOVARO',
    Nicaragua: 'EQUINOVARO',
    880: 'WALKFORLIFE',
    Bangladesh: 'WALKFORLIFE',
    62: 'YAYASAN-SSB',
    Indonesia: 'YAYASAN-SSB',
    95: 'WALKFORLIFE',
    Myanmar: 'WALKFORLIFE',
    977: 'YAYASAN-SSB',
    Nepal: 'YAYASAN-SSB',
    63: 'PNGOC',
    Philippines: 'PNGOC',
    94: 'HICLUBFOOT',
    'Sri Lanka': 'HICLUBFOOT',
  };

  const languageCodeMap = {
    English: 'EN',
    French: 'FRA',
    Spanish: 'ES',
    Malagasy: 'MLG',
    Burmese: 'MYA',
    Khmer: 'KHM',
    Nepali: 'NEP',
    Swahili: 'SW',
    Tagalog: 'TGL',
    Wolof: 'WOL',
    PHI: 'PHI',
  };

  const alertsToSend = [];
  alertsToSend.push(treatmentMap['bracing_night_y1']);

  console.log('alerts to send', alertsToSend);

  return {
    ...state,
    alertsToSend,
    mapping,
    PhoneMapping,
    timeZoneMap,
    countryToTimeZone,
    languageCodeMap,
  };
});

fn(async state => {
  const { host, token } = state.configuration;

  function getSMS(bulkId) {
    return get(
      `${host}/1/bulks/status?bulkId=${bulkId}`,
      {
        headers: {
          'Content-Type': 'application/json',
          Authorization: `App ${token}`,
        },
        options: {
          successCodes: [200, 404],
        },
      },
      state => {
        const response = state.data;
        if (
          response.bulkId ||
          (response.requestError &&
            response.requestError.serviceException &&
            response.requestError.serviceException.messageId === 'NOT_FOUND')
        ) {
          return response;
        }
        return new Error(response);
      }
    )(state);
  }

  function scheduleSMS(bulkId, message) {
    return post(`${host}/2/text/advanced`, {
      headers: {
        'Content-Type': 'application/json',
        Authorization: `App ${token}`,
      },
      body: {
        bulkId,
        messages: [message],
      },
    })(state);
  }

  function rescheduleSMS(bulkId, sendAt) {
    return put(`${host}/1/bulks?bulkId=${bulkId}`, {
      headers: {
        'Content-Type': 'application/json',
        Authorization: `App ${token}`,
      },
      body: {
        sendAt,
      },
    })(state);
  }

  const { alertsToSend, mapping, contacts } = state;

  await each(contacts, async state => {
    const language_code = 'English';
    function fetch_data_from_multiple_path(value) {
      let paths = [];
      if (value.includes('||')) {
        const path_arrays = value.split(' || ');
        paths = path_arrays.filter(path => {
          return dataValue(`${path}`)(state);
        });
        return paths[0];
      }
      return value;
    }

    const setHoursFromRule = rule =>
      rule['Clock Time']
        ? rule['Clock Time'].split(':')[0]
        : new Date().getHours();

    const setMinutesFromRule = rule =>
      rule['Clock Time']
        ? rule['Clock Time'].split(':')[1]
        : new Date().getMinutes();

    // SCHEDULE SMS PROCESS =======================================================
    for (let alert of alertsToSend) {
      console.log('============= START SMS SCHEDULE =============');
      const { key, bulkPrefix } = alert;
      delete state.previousSMS;
      for (let rule of mapping[key]) {
        console.log('=======================================');
        console.log(
          `rule ${key} 'Schedule Start Date (SSD):`,
          rule['Schedule Start Date (SSD)']
        );
        const start_date =
          fetch_data_from_multiple_path(rule['Schedule Start Date (SSD)']) ||
          rule['Schedule Start Date (SSD)'];

        console.log('Start date fetched: ', start_date);

        const date =
          start_date === 'now' ? Date.now() : dataValue(`${start_date}`)(state);

        console.log(
          `For ${alert.key}, we're looking in ${start_date} and finding:`,
          new Date(date).toISOString()
        );

        if (!date) {
          console.log('Skipping schedule because date is empty');
          break;
        }
        let sendAtDate = new Date(date);

        // We build the bulkId for this alert from the case type the `# SMS` and the `@case_id`
        // let bulkId = `${bulkPrefix}${rule['# SMS']}-${form.case['@case_id']}`;
        let bulkId = `${bulkPrefix}${rule['# SMS']}`;
        console.log('bulkId: ', bulkId);

        const sms = rule[state.languageCodeMap[language_code]]
          .map((item, pos) =>
            pos % 2 === 0
              ? item
              : dataValue(`${fetch_data_from_multiple_path(item)}`)(state)
          )
          .join('');

        sendAtDate.setDate(sendAtDate.getDate() + rule['Days from SSD']);

        const hours = setHoursFromRule(rule);
        const minutes = setMinutesFromRule(rule);

        sendAtDate.setHours(parseInt(hours));
        sendAtDate.setMinutes(
          parseInt(minutes) + (rule['Min From SSD'] ? rule['Min From SSD'] : 0)
        );

        // Delay sending date =========================================
        if (sendAtDate.getHours() >= 20) {
          sendAtDate.setDate(sendAtDate.getDate() + 1);
        }
        if (sendAtDate.getHours() >= 20 || sendAtDate.getHours() < 8) {
          sendAtDate.setHours(8);
        }
        // ============================================================

        const sendAt = sendAtDate.toISOString();
        // const to = form.calcs.sms.contact_phone_number; // TODO: get contact_phone_number
        const to = null;
        console.log('sending to', to);
        // if (!to) {
        //   console.log('No phone number defined! Skipping SMS scheduling.');
        //   return state;
        // }
        console.log('Sending SMS at: ', sendAt);

        // const dataForTheFromPhoneNumber =
        //   (form.calcs.phone_numbers_country_code
        //     ? form.calcs.phone_numbers_country_code.phone_country_code
        //     : form.calcs.phone_numbers.phone_country_code) ||
        //   form.calcs.locations.country;

        // const from = state.PhoneMapping[dataForTheFromPhoneNumber];
        const from = null;

        const message = {
          from,
          destinations: [
            {
              to,
            },
          ],
          text: sms,
          sendAt,
        };

        // Send SMS ====================================================
        console.log(`Check for existing scheduled SMS for ${bulkId}...`);
        await getSMS(bulkId).then(res => {
          if (res.requestError) {
            // b. if no sms found for visitAfter we set the new bulkId with next_visit_date
            console.log(
              `Existing SMS not found. Scheduling SMS for ${bulkId} at ${message.sendAt}...`
            );
            console.log('Sending message:', message);
            return scheduleSMS(bulkId, message);
          } else {
            if (res.status === 'FINISHED' || res.status === 'CANCELED') {
              console.log(
                'SMS is already canceled or sent, impossible to reschedule!'
              );
              return state;
            }
            const reschedule_date = fetch_data_from_multiple_path(
              rule['Schedule Start Date (SSD)']
            );

            const next_visit_date =
              reschedule_date === 'now'
                ? Date.now()
                : dataValue(`${reschedule_date}`)(state);

            let sendAtDate = new Date(next_visit_date);

            sendAtDate.setDate(sendAtDate.getDate() + rule['Days from SSD']);

            const hours = setHoursFromRule(rule);
            const minutes = setHoursFromRule(rule);

            sendAtDate.setHours(parseInt(hours));
            sendAtDate.setMinutes(
              parseInt(minutes) +
                (rule['Min From SSD'] ? rule['Min From SSD'] : 0)
            );

            const sendAt = sendAtDate.toISOString();

            console.log(
              `SMS already scheduled. Rescheduling for ${bulkId} at ${sendAt}...`
            );
            console.log('Sending message:', message);

            return rescheduleSMS(bulkId, sendAt);
          }
        });
        // END Send SMS ================================================
        console.log('=======================================\n');
      }
      console.log('============= END SMS SCHEDULE =============\n');
    }
    return state;
  })(state);
});
